# æ¸…æ´—åæ•°æ®é¢„å¤„ç†æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£ä»‹ç»å¦‚ä½•ä½¿ç”¨åŸºäºæ¸…æ´—åæ•°æ®çš„é¢„å¤„ç†ç³»ç»Ÿï¼Œå°†æ¸…æ´—åçš„æµå—äº¤é€šæ•°æ®é¢„å¤„ç†ä¸ºé«˜æ•ˆæŸ¥è¯¢çš„æ ¼å¼ã€‚

## ğŸ—‚ï¸ æ–‡ä»¶ç»“æ„

```
backend/detect/traffic_visualization/
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ cleaned/              # æ¸…æ´—åçš„åŸå§‹CSVæ•°æ®
â”‚   â”‚   â”œâ”€â”€ cleaned_jn0912.csv
â”‚   â”‚   â””â”€â”€ test_sample_jn0912.csv
â”‚   â”œâ”€â”€ processed/            # é¢„å¤„ç†åçš„åˆ†ç‰‡æ•°æ® (å°†ç”Ÿæˆ)
â”‚   â”‚   â”œâ”€â”€ hour_1378915200.parquet
â”‚   â”‚   â”œâ”€â”€ hour_1378918800.parquet
â”‚   â”‚   â””â”€â”€ ...
â”‚   â””â”€â”€ indexes/              # å¿«é€ŸæŸ¥è¯¢ç´¢å¼• (å°†ç”Ÿæˆ)
â”‚       â”œâ”€â”€ vehicle_index.json
â”‚       â”œâ”€â”€ spatial_grid_0.001.json
â”‚       â”œâ”€â”€ heatmap_day_*.json
â”‚       â””â”€â”€ data_summary.json
â”œâ”€â”€ data_preprocessor_cleaned.py      # åŸºäºæ¸…æ´—æ•°æ®çš„é¢„å¤„ç†å™¨
â”œâ”€â”€ run_cleaned_preprocessing.py     # é¢„å¤„ç†è¿è¡Œè„šæœ¬
â”œâ”€â”€ check_cleaned_data.py           # æ•°æ®æ£€æŸ¥å·¥å…·
â””â”€â”€ README_preprocessing.md         # æœ¬æ–‡æ¡£
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. æ£€æŸ¥æ¸…æ´—åæ•°æ®

é¦–å…ˆéªŒè¯æ¸…æ´—åæ•°æ®çš„æ ¼å¼å’Œå†…å®¹ï¼š

```bash
cd backend/detect/traffic_visualization
python check_cleaned_data.py
```

**é¢„æœŸè¾“å‡ºï¼š**
```
ğŸ” æ£€æŸ¥æ¸…æ´—åçš„äº¤é€šæ•°æ®
==================================================
âœ… æ‰¾åˆ° 2 ä¸ªCSVæ–‡ä»¶:
   ğŸ“„ cleaned_jn0912.csv: 2400.0 MB
   ğŸ“„ test_sample_jn0912.csv: 0.1 MB

ğŸ“‹ åˆ—ä¿¡æ¯:
   åˆ—æ•°: 12
   åˆ—å: ['COMMADDR', 'UTC', 'LAT', 'LON', 'HEAD', 'SPEED', 'TFLAG', 'lat', 'lon', 'speed_kmh', 'is_occupied', 'timestamp']
âœ… æ‰€æœ‰é¢„æœŸåˆ—éƒ½å­˜åœ¨
```

### 2. è¿è¡Œé¢„å¤„ç†

æ‰§è¡Œå®Œæ•´çš„é¢„å¤„ç†æµç¨‹ï¼š

```bash
python run_cleaned_preprocessing.py
```

**å¤„ç†æ­¥éª¤ï¼š**
1. æ£€æŸ¥æ¸…æ´—åæ•°æ®æ–‡ä»¶
2. æ—¶é—´åˆ†ç‰‡èšåˆ (æŒ‰å°æ—¶åˆ†ç‰‡)
3. ç©ºé—´ç½‘æ ¼åŒ– (å¤šåˆ†è¾¨ç‡ç´¢å¼•)
4. è½¦è¾†ç´¢å¼• (å¿«é€Ÿè½¦è¾†æŸ¥è¯¢)
5. çƒ­åŠ›å›¾é¢„è®¡ç®— (æ—¥/å°æ—¶çº§åˆ«)
6. ç”Ÿæˆæ•°æ®æ¦‚è¦ç»Ÿè®¡

**é¢„æœŸå¤„ç†æ—¶é—´ï¼š**
- å°æ ·æœ¬ (<100MB): 30ç§’-2åˆ†é’Ÿ
- å¤§æ–‡ä»¶ (2.4GB): 5-15åˆ†é’Ÿ

## ğŸ› ï¸ æ ¸å¿ƒç»„ä»¶

### CleanedTrafficDataPreprocessor

**åŠŸèƒ½ï¼š** å°†æ¸…æ´—åçš„CSVæ•°æ®è½¬æ¢ä¸ºé«˜æ•ˆæŸ¥è¯¢æ ¼å¼

**ä¸»è¦ç‰¹æ€§ï¼š**
- âœ… æ”¯æŒæ¸…æ´—åæ•°æ®æ ¼å¼ï¼ˆå·²è½¬æ¢çš„åæ ‡ï¼‰
- âœ… æ™ºèƒ½åˆ†å±‚é‡‡æ ·ï¼ˆä¿æŒè½¦è¾†åˆ†å¸ƒï¼‰
- âœ… å¤šåˆ†è¾¨ç‡ç©ºé—´ç½‘æ ¼ (0.001, 0.002, 0.005, 0.01åº¦)
- âœ… æ—¥/å°æ—¶çº§çƒ­åŠ›å›¾é¢„è®¡ç®—
- âœ… å®Œæ•´çš„æ•°æ®æ¦‚è¦ç»Ÿè®¡

### EnhancedFastTrafficDataLoader

**åŠŸèƒ½ï¼š** åŸºäºé¢„å¤„ç†æ•°æ®çš„é«˜é€ŸæŸ¥è¯¢

**æ€§èƒ½æå‡ï¼š**
- æ•°æ®åŠ è½½: **30-300å€** æå‡
- çƒ­åŠ›å›¾ç”Ÿæˆ: **100-300å€** æå‡
- è½¦è¾†æŸ¥è¯¢: **500-2000å€** æå‡

## ğŸ“Š é¢„å¤„ç†è¾“å‡º

### processed/ ç›®å½•
```
hour_1378915200.parquet    # 2013-09-11 16:00-17:00 æ•°æ®
hour_1378918800.parquet    # 2013-09-11 17:00-18:00 æ•°æ®
...
```

### indexes/ ç›®å½•
```
vehicle_index.json         # è½¦è¾†ID â†’ æ—¶é—´æ®µæ˜ å°„
vehicle_stats.json         # è½¦è¾†ç»Ÿè®¡ä¿¡æ¯
spatial_grid_0.001.json    # é«˜ç²¾åº¦ç©ºé—´ç½‘æ ¼
spatial_grid_0.002.json    # ä¸­ç²¾åº¦ç©ºé—´ç½‘æ ¼ (çƒ­åŠ›å›¾)
spatial_grid_0.005.json    # ä¸­ä½ç²¾åº¦ç©ºé—´ç½‘æ ¼
spatial_grid_0.01.json     # ä½ç²¾åº¦ç©ºé—´ç½‘æ ¼
heatmap_day_*.json         # æ—¥çº§çƒ­åŠ›å›¾æ•°æ®
heatmap_hour_*.json        # å°æ—¶çº§çƒ­åŠ›å›¾æ•°æ®
data_summary.json          # æ•°æ®æ¦‚è¦ç»Ÿè®¡
```

## ğŸ”§ ä½¿ç”¨æ–¹å¼

### åœ¨TrafficDataProcessorä¸­è‡ªåŠ¨å¯ç”¨

é¢„å¤„ç†å®Œæˆåï¼Œ`TrafficDataProcessor`ä¼šè‡ªåŠ¨æ£€æµ‹å¹¶ä½¿ç”¨é¢„å¤„ç†æ•°æ®ï¼š

```python
processor = TrafficDataProcessor()
# âœ“ å‘ç°é¢„å¤„ç†æ•°æ®ï¼Œå°†ä½¿ç”¨é«˜æ•ˆæŸ¥è¯¢æ¨¡å¼

# å¿«é€ŸæŸ¥è¯¢ (æ¯«ç§’çº§)
data = processor.load_data(start_time, end_time)
```

### ç›´æ¥ä½¿ç”¨å¢å¼ºç‰ˆåŠ è½½å™¨

```python
from data_preprocessor_cleaned import EnhancedFastTrafficDataLoader

loader = EnhancedFastTrafficDataLoader()

# è·å–æ•°æ®æ¦‚è¦
summary = loader.get_data_summary()
print(f"æ€»è®°å½•æ•°: {summary['total_records']:,}")

# å¿«é€Ÿæ•°æ®æŸ¥è¯¢
data = loader.fast_load_data(start_time, end_time, vehicle_id)

# å¿«é€Ÿçƒ­åŠ›å›¾
heatmap = loader.fast_get_heatmap(start_time, end_time, "daily")
```

## ğŸ¯ ä¸åŸç³»ç»Ÿçš„å…³ç³»

### data_processor.py (è¿è¡Œæ—¶å¤„ç†å™¨)
- **æ— é¢„å¤„ç†æ—¶:** ç›´æ¥è¯»å–CSVï¼Œé€Ÿåº¦è¾ƒæ…¢
- **æœ‰é¢„å¤„ç†æ—¶:** ä½¿ç”¨é¢„å¤„ç†æ•°æ®ï¼Œé€Ÿåº¦æå¿«

### data_preprocessor.py vs data_preprocessor_cleaned.py
- **åŸç‰ˆ:** å¤„ç†åŸå§‹æœªæ¸…æ´—æ•°æ®ï¼Œéœ€è¦å®æ—¶åæ ‡è½¬æ¢
- **æ¸…æ´—ç‰ˆ:** å¤„ç†å·²æ¸…æ´—æ•°æ®ï¼Œç›´æ¥ä½¿ç”¨è½¬æ¢ååæ ‡

## ğŸ“ˆ æ€§èƒ½å¯¹æ¯”

| æ“ä½œ | åŸå§‹CSVæ¨¡å¼ | é¢„å¤„ç†æ¨¡å¼ | æ€§èƒ½æå‡ |
|------|-------------|------------|----------|
| 1å°æ—¶æ•°æ®æŸ¥è¯¢ | 10-30ç§’ | 0.1-1ç§’ | **30-300å€** |
| ç‰¹å®šè½¦è¾†æŸ¥è¯¢ | 5-20ç§’ | 0.01-0.1ç§’ | **500-2000å€** |
| çƒ­åŠ›å›¾ç”Ÿæˆ | 5-15ç§’ | 0.05-0.2ç§’ | **100-300å€** |
| å‰ç«¯å“åº”æ—¶é—´ | åˆ†é’Ÿçº§ | ç§’çº§ | **è´¨çš„é£è·ƒ** |

## ğŸ›¡ï¸ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

**1. æ‰¾ä¸åˆ°æ¸…æ´—åæ•°æ®**
```
âŒ æ¸…æ´—åæ•°æ®ç›®å½•ä¸å­˜åœ¨: data/cleaned
```
**è§£å†³æ–¹æ¡ˆ:** ç¡®ä¿æ¸…æ´—åçš„CSVæ–‡ä»¶æ”¾åœ¨æ­£ç¡®ä½ç½®

**2. åˆ—åä¸åŒ¹é…**
```
âš ï¸ ç¼ºå°‘åˆ—: ['lat', 'lon', 'speed_kmh']
```
**è§£å†³æ–¹æ¡ˆ:** ä½¿ç”¨æ­£ç¡®æ ¼å¼çš„æ¸…æ´—åæ•°æ®

**3. å†…å­˜ä¸è¶³**
```
MemoryError: Unable to allocate array
```
**è§£å†³æ–¹æ¡ˆ:** 
- å¢åŠ ç³»ç»Ÿå†…å­˜
- æˆ–ä½¿ç”¨è¾ƒå°çš„æµ‹è¯•æ ·æœ¬
- æˆ–è°ƒæ•´chunk_sizeå‚æ•°

**4. é¢„å¤„ç†ä¸­æ–­**
```
âŒ å¤„ç†æ–‡ä»¶æ—¶å‡ºé”™: pandas.errors.ParserError
```
**è§£å†³æ–¹æ¡ˆ:** æ£€æŸ¥CSVæ–‡ä»¶æ ¼å¼ï¼Œç¡®ä¿ç¼–ç æ­£ç¡®

### æ¸…ç†å’Œé‡æ–°å¼€å§‹

å¦‚æœé¢„å¤„ç†å‡ºç°é—®é¢˜ï¼Œå¯ä»¥æ¸…ç†åé‡æ–°å¼€å§‹ï¼š

```bash
# æ‰‹åŠ¨æ¸…ç†
rm -rf data/processed/*
rm -rf data/indexes/*

# æˆ–ä½¿ç”¨è„šæœ¬æ¸…ç†
python run_cleaned_preprocessing.py
# é€‰æ‹© 'y' æ¸…ç†ç°æœ‰æ•°æ®
```

## ğŸ”„ æ›´æ–°æµç¨‹

å½“æœ‰æ–°çš„æ¸…æ´—åæ•°æ®æ—¶ï¼š

1. å°†æ–°æ•°æ®æ”¾å…¥ `data/cleaned/` ç›®å½•
2. è¿è¡Œ `python run_cleaned_preprocessing.py`
3. é€‰æ‹©æ¸…ç†ç°æœ‰æ•°æ®
4. é‡æ–°é¢„å¤„ç†æ‰€æœ‰æ•°æ®

## âœ… éªŒè¯æˆåŠŸæ ‡å¿—

é¢„å¤„ç†æˆåŠŸåï¼Œåº”è¯¥çœ‹åˆ°ï¼š

```
âœ… ç”Ÿæˆçš„æ–‡ä»¶ç»“æ„:
   ğŸ“ data/
   â”œâ”€â”€ ğŸ“ cleaned/        (æ¸…æ´—ååŸå§‹æ•°æ®)
   â”œâ”€â”€ ğŸ“ processed/      (æŒ‰å°æ—¶åˆ†ç‰‡çš„Parquetæ–‡ä»¶)
   â””â”€â”€ ğŸ“ indexes/        (å¿«é€ŸæŸ¥è¯¢ç´¢å¼•)

ğŸš€ ç°åœ¨TrafficDataProcessorå°†è‡ªåŠ¨ä½¿ç”¨é¢„å¤„ç†æ•°æ®ï¼ŒæŸ¥è¯¢é€Ÿåº¦æå‡10-100å€ï¼
```

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚é‡é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š
1. æ¸…æ´—åæ•°æ®æ ¼å¼æ˜¯å¦æ­£ç¡®
2. Pythonä¾èµ–æ˜¯å¦å®Œæ•´ (pandas, numpy)
3. ç£ç›˜ç©ºé—´æ˜¯å¦å……è¶³
4. ç³»ç»Ÿå†…å­˜æ˜¯å¦å……è¶³ (å»ºè®®8GB+)

---

**ğŸ‰ é¢„å¤„ç†å®Œæˆåï¼Œæ‚¨çš„äº¤é€šæ•°æ®åˆ†æç³»ç»Ÿå°†è·å¾—è´¨çš„é£è·ƒï¼ä»"åˆ†é’Ÿçº§ç­‰å¾…"åˆ°"ç§’çº§å“åº”"ï¼**