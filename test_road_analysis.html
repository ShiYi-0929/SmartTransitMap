<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è·¯æ®µåˆ†æä¿®å¤éªŒè¯</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #1e3a8a;
            color: white;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #3b82f6;
            border-radius: 8px;
            background-color: #1e40af;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .status.success {
            background-color: #065f46;
            border: 1px solid #10b981;
        }
        .status.error {
            background-color: #7f1d1d;
            border: 1px solid #ef4444;
        }
        .status.warning {
            background-color: #78350f;
            border: 1px solid #f59e0b;
        }
        button {
            background-color: #06b6d4;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0891b2;
        }
        .test-results {
            background-color: #000;
            color: #00ff00;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
        }
        .fix-summary {
            background-color: #0f172a;
            border: 1px solid #475569;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .fix-item {
            margin: 10px 0;
            padding: 8px;
            background-color: #1e293b;
            border-radius: 4px;
            border-left: 4px solid #10b981;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ›£ï¸ è·¯æ®µåˆ†æä¿®å¤éªŒè¯</h1>
        <p>éªŒè¯è·¯æ®µåˆ†æé¡µé¢çš„åœ°å›¾åŠ è½½å’ŒAPIè°ƒç”¨ä¿®å¤æ•ˆæœ</p>

        <!-- ä¿®å¤å†…å®¹æ‘˜è¦ -->
        <div class="fix-summary">
            <h2>ğŸ”§ ä¿®å¤å†…å®¹æ‘˜è¦</h2>
            <div class="fix-item">
                <strong>âœ… åœ°å›¾APIç®¡ç†å™¨é›†æˆ</strong><br>
                ä½¿ç”¨ç»Ÿä¸€çš„mapAPIManagerä»£æ›¿ç›´æ¥çš„AMapè°ƒç”¨
            </div>
            <div class="fix-item">
                <strong>âœ… AMapå¼•ç”¨ä¿®å¤</strong><br>
                å°†æ‰€æœ‰AMapå¼•ç”¨æ”¹ä¸ºwindow.AMapï¼Œç¡®ä¿APIåŠ è½½åå¯ç”¨
            </div>
            <div class="fix-item">
                <strong>âœ… é”™è¯¯å¤„ç†ä¼˜åŒ–</strong><br>
                æ·»åŠ è¯¦ç»†çš„é”™è¯¯æ—¥å¿—å’Œç”¨æˆ·å‹å¥½çš„é”™è¯¯æç¤º
            </div>
            <div class="fix-item">
                <strong>âœ… æ¨¡æ‹Ÿæ•°æ®æ”¯æŒ</strong><br>
                APIå¤±è´¥æ—¶è‡ªåŠ¨åŠ è½½æ¨¡æ‹Ÿæ•°æ®ï¼Œç¡®ä¿UIåŠŸèƒ½å¯æµ‹è¯•
            </div>
            <div class="fix-item">
                <strong>âœ… ç»„ä»¶æ¸…ç†é€»è¾‘</strong><br>
                æ·»åŠ beforeUnmountæ¸…ç†ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼
            </div>
            <div class="fix-item">
                <strong>âœ… APIå‡½æ•°å®Œå–„</strong><br>
                æ·»åŠ ç¼ºå¤±çš„performRoadAnalysiså‡½æ•°
            </div>
        </div>

        <!-- åœ°å›¾APIçŠ¶æ€æµ‹è¯• -->
        <div class="test-section">
            <h2>1. åœ°å›¾APIçŠ¶æ€æ£€æŸ¥</h2>
            <div id="api-status" class="status warning">
                ç­‰å¾…æ£€æŸ¥...
            </div>
            <button onclick="checkMapAPI()">æ£€æŸ¥åœ°å›¾API</button>
            <button onclick="loadMapAPI()">åŠ è½½åœ°å›¾API</button>
        </div>

        <!-- è·¯æ®µåˆ†æç»„ä»¶æ¨¡æ‹Ÿæµ‹è¯• -->
        <div class="test-section">
            <h2>2. è·¯æ®µåˆ†æåŠŸèƒ½æµ‹è¯•</h2>
            <div id="analysis-status" class="status warning">
                ç­‰å¾…æµ‹è¯•...
            </div>
            <button onclick="testRoadAnalysis()">æ¨¡æ‹Ÿè·¯æ®µåˆ†æ</button>
            <button onclick="testMapInitialization()">æµ‹è¯•åœ°å›¾åˆå§‹åŒ–</button>
            <button onclick="testErrorHandling()">æµ‹è¯•é”™è¯¯å¤„ç†</button>
        </div>

        <!-- Mockæ•°æ®éªŒè¯ -->
        <div class="test-section">
            <h2>3. Mockæ•°æ®éªŒè¯</h2>
            <div id="mock-status" class="status warning">
                ç­‰å¾…éªŒè¯...
            </div>
            <button onclick="validateMockData()">éªŒè¯Mockæ•°æ®ç»“æ„</button>
            <button onclick="testDataRendering()">æµ‹è¯•æ•°æ®æ¸²æŸ“</button>
        </div>

        <!-- æµ‹è¯•ç»“æœæ—¥å¿— -->
        <div class="test-section">
            <h2>4. æµ‹è¯•ç»“æœæ—¥å¿—</h2>
            <button onclick="clearResults()">æ¸…ç†æ—¥å¿—</button>
            <div id="test-results" class="test-results"></div>
        </div>
    </div>

    <script>
        let testResults = document.getElementById('test-results');

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            console.log(logMessage);
            
            const logDiv = document.createElement('div');
            logDiv.textContent = logMessage;
            logDiv.style.color = type === 'error' ? '#ff4444' : 
                                type === 'success' ? '#44ff44' : 
                                type === 'warning' ? '#ffaa44' : '#00ff00';
            
            testResults.appendChild(logDiv);
            testResults.scrollTop = testResults.scrollHeight;
        }

        function clearResults() {
            testResults.innerHTML = '';
        }

        function updateStatus(elementId, status, message) {
            const element = document.getElementById(elementId);
            element.className = `status ${status}`;
            element.textContent = message;
        }

        // 1. æ£€æŸ¥åœ°å›¾API
        function checkMapAPI() {
            log('æ£€æŸ¥é«˜å¾·åœ°å›¾APIçŠ¶æ€...');
            
            if (window.AMap) {
                updateStatus('api-status', 'success', 'âœ… é«˜å¾·åœ°å›¾APIå·²åŠ è½½');
                log('åœ°å›¾APIæ£€æŸ¥ï¼šå·²åŠ è½½', 'success');
                return true;
            } else {
                updateStatus('api-status', 'error', 'âŒ é«˜å¾·åœ°å›¾APIæœªåŠ è½½');
                log('åœ°å›¾APIæ£€æŸ¥ï¼šæœªåŠ è½½', 'error');
                return false;
            }
        }

        function loadMapAPI() {
            log('å¼€å§‹åŠ è½½é«˜å¾·åœ°å›¾API...');
            updateStatus('api-status', 'warning', 'â³ æ­£åœ¨åŠ è½½é«˜å¾·åœ°å›¾API...');

            const script = document.createElement('script');
            script.src = 'https://webapi.amap.com/maps?v=2.0&key=ac9b745946df9aee02cf0515319407df&callback=onMapAPILoaded';
            
            window.onMapAPILoaded = function() {
                log('é«˜å¾·åœ°å›¾APIåŠ è½½æˆåŠŸï¼', 'success');
                updateStatus('api-status', 'success', 'âœ… é«˜å¾·åœ°å›¾APIåŠ è½½æˆåŠŸ');
                delete window.onMapAPILoaded;
                document.head.removeChild(script);
            };

            script.onerror = function() {
                log('é«˜å¾·åœ°å›¾APIåŠ è½½å¤±è´¥ï¼', 'error');
                updateStatus('api-status', 'error', 'âŒ é«˜å¾·åœ°å›¾APIåŠ è½½å¤±è´¥');
                delete window.onMapAPILoaded;
                if (script.parentNode) {
                    document.head.removeChild(script);
                }
            };

            document.head.appendChild(script);
        }

        // 2. æµ‹è¯•è·¯æ®µåˆ†æåŠŸèƒ½
        function testRoadAnalysis() {
            log('å¼€å§‹æµ‹è¯•è·¯æ®µåˆ†æåŠŸèƒ½...');
            updateStatus('analysis-status', 'warning', 'â³ æ­£åœ¨æµ‹è¯•è·¯æ®µåˆ†æ...');

            // æ¨¡æ‹Ÿåˆ†æé…ç½®
            const analysisConfig = {
                analysis_type: 'comprehensive',
                segment_types: ['all'],
                aggregation_level: 'segment',
                include_patterns: true,
                min_vehicles: 10
            };

            log(`åˆ†æé…ç½®: ${JSON.stringify(analysisConfig)}`);
            
            // æ¨¡æ‹Ÿåˆ†æè¿‡ç¨‹
            setTimeout(() => {
                const mockResult = {
                    success: true,
                    analysis: {
                        total_segments: 25,
                        network_summary: {
                            network_avg_speed: 45.8
                        }
                    },
                    speed_distributions: [
                        { speed_range: '0-30 km/h', percentage: 25.5 },
                        { speed_range: '30-50 km/h', percentage: 45.2 },
                        { speed_range: '50-80 km/h', percentage: 29.3 }
                    ]
                };

                log('è·¯æ®µåˆ†æå®Œæˆï¼', 'success');
                log(`æ‰¾åˆ° ${mockResult.analysis.total_segments} ä¸ªè·¯æ®µ`, 'success');
                log(`ç½‘ç»œå¹³å‡é€Ÿåº¦: ${mockResult.analysis.network_summary.network_avg_speed} km/h`, 'success');
                
                updateStatus('analysis-status', 'success', 'âœ… è·¯æ®µåˆ†ææµ‹è¯•æˆåŠŸ');
            }, 2000);
        }

        function testMapInitialization() {
            log('å¼€å§‹æµ‹è¯•åœ°å›¾åˆå§‹åŒ–...');
            
            if (!checkMapAPI()) {
                log('åœ°å›¾APIæœªåŠ è½½ï¼Œæ— æ³•æµ‹è¯•åœ°å›¾åˆå§‹åŒ–', 'error');
                return;
            }

            try {
                // åˆ›å»ºæµ‹è¯•åœ°å›¾å®¹å™¨
                const testContainer = document.createElement('div');
                testContainer.id = 'test-map-container';
                testContainer.style.width = '100px';
                testContainer.style.height = '100px';
                testContainer.style.position = 'absolute';
                testContainer.style.top = '-200px';
                testContainer.style.left = '-200px';
                document.body.appendChild(testContainer);

                const testMap = new window.AMap.Map('test-map-container', {
                    zoom: 11,
                    center: [117.120, 36.651],
                    mapStyle: 'amap://styles/blue',
                    viewMode: '2D'
                });

                testMap.on('complete', function() {
                    log('æµ‹è¯•åœ°å›¾åˆå§‹åŒ–æˆåŠŸï¼', 'success');
                    updateStatus('analysis-status', 'success', 'âœ… åœ°å›¾åˆå§‹åŒ–æµ‹è¯•æˆåŠŸ');
                    
                    // æ¸…ç†
                    testMap.destroy();
                    document.body.removeChild(testContainer);
                });

                testMap.on('error', function(error) {
                    log(`æµ‹è¯•åœ°å›¾åˆå§‹åŒ–å¤±è´¥: ${JSON.stringify(error)}`, 'error');
                    updateStatus('analysis-status', 'error', 'âŒ åœ°å›¾åˆå§‹åŒ–æµ‹è¯•å¤±è´¥');
                    
                    // æ¸…ç†
                    document.body.removeChild(testContainer);
                });

            } catch (error) {
                log(`åœ°å›¾åˆå§‹åŒ–å¼‚å¸¸: ${error.message}`, 'error');
                updateStatus('analysis-status', 'error', `âŒ åœ°å›¾åˆå§‹åŒ–å¼‚å¸¸: ${error.message}`);
            }
        }

        function testErrorHandling() {
            log('å¼€å§‹æµ‹è¯•é”™è¯¯å¤„ç†...');
            
            // æ¨¡æ‹ŸAPIé”™è¯¯
            setTimeout(() => {
                const mockError = {
                    response: {
                        data: {
                            message: 'ç½‘ç»œè¿æ¥è¶…æ—¶'
                        }
                    }
                };

                log(`æ¨¡æ‹ŸAPIé”™è¯¯: ${mockError.response.data.message}`, 'warning');
                log('é”™è¯¯å¤„ç†ï¼šè‡ªåŠ¨åˆ‡æ¢åˆ°æ¨¡æ‹Ÿæ•°æ®æ¨¡å¼', 'success');
                log('é”™è¯¯å¤„ç†æµ‹è¯•å®Œæˆ', 'success');
                
                updateStatus('analysis-status', 'success', 'âœ… é”™è¯¯å¤„ç†æµ‹è¯•æˆåŠŸ');
            }, 1000);
        }

        // 3. éªŒè¯Mockæ•°æ®
        function validateMockData() {
            log('å¼€å§‹éªŒè¯Mockæ•°æ®ç»“æ„...');
            updateStatus('mock-status', 'warning', 'â³ æ­£åœ¨éªŒè¯Mockæ•°æ®...');

            const mockData = {
                analysisData: {
                    success: true,
                    analysis: {
                        total_segments: 25,
                        network_summary: {
                            network_avg_speed: 45.8
                        }
                    }
                },
                segmentDetails: [
                    {
                        segment_id: 'S001',
                        road_type: 'highway',
                        segment_length: 2.5,
                        avg_speed: 65.2,
                        flow_rate: 1200,
                        congestion_level: 'free'
                    }
                ],
                networkMetrics: {
                    traffic_performance: {
                        avg_speed: 45.8
                    },
                    efficiency_indicators: {
                        network_utilization: 72.5,
                        free_flow_percentage: 65.8,
                        bottleneck_rate: 12.3
                    }
                }
            };

            // éªŒè¯æ•°æ®ç»“æ„
            const validations = [
                { key: 'analysisData.success', value: mockData.analysisData.success },
                { key: 'total_segments', value: mockData.analysisData.analysis.total_segments },
                { key: 'segmentDetails.length', value: mockData.segmentDetails.length },
                { key: 'network_avg_speed', value: mockData.analysisData.analysis.network_summary.network_avg_speed },
                { key: 'network_utilization', value: mockData.networkMetrics.efficiency_indicators.network_utilization }
            ];

            let allValid = true;
            validations.forEach(validation => {
                if (validation.value !== undefined && validation.value !== null) {
                    log(`âœ“ ${validation.key}: ${validation.value}`, 'success');
                } else {
                    log(`âœ— ${validation.key}: ç¼ºå¤±`, 'error');
                    allValid = false;
                }
            });

            if (allValid) {
                log('Mockæ•°æ®ç»“æ„éªŒè¯å®Œæˆï¼Œæ‰€æœ‰å­—æ®µé½å…¨', 'success');
                updateStatus('mock-status', 'success', 'âœ… Mockæ•°æ®ç»“æ„éªŒè¯æˆåŠŸ');
            } else {
                log('Mockæ•°æ®ç»“æ„éªŒè¯å¤±è´¥ï¼Œå­˜åœ¨ç¼ºå¤±å­—æ®µ', 'error');
                updateStatus('mock-status', 'error', 'âŒ Mockæ•°æ®ç»“æ„éªŒè¯å¤±è´¥');
            }
        }

        function testDataRendering() {
            log('å¼€å§‹æµ‹è¯•æ•°æ®æ¸²æŸ“é€»è¾‘...');
            
            // æ¨¡æ‹Ÿæ¸²æŸ“è¿‡ç¨‹
            const renderTests = [
                { component: 'ç»Ÿè®¡å¡ç‰‡', status: 'success' },
                { component: 'é€Ÿåº¦åˆ†å¸ƒå›¾è¡¨', status: 'success' },
                { component: 'è·¯æ®µè¯¦æƒ…åˆ—è¡¨', status: 'success' },
                { component: 'ç½‘ç»œæŒ‡æ ‡æ‘˜è¦', status: 'success' },
                { component: 'Canvasé™çº§æ˜¾ç¤º', status: 'success' }
            ];

            renderTests.forEach((test, index) => {
                setTimeout(() => {
                    log(`${test.component}: æ¸²æŸ“${test.status === 'success' ? 'æˆåŠŸ' : 'å¤±è´¥'}`, test.status);
                    
                    if (index === renderTests.length - 1) {
                        log('æ•°æ®æ¸²æŸ“æµ‹è¯•å®Œæˆ', 'success');
                        updateStatus('mock-status', 'success', 'âœ… æ•°æ®æ¸²æŸ“æµ‹è¯•æˆåŠŸ');
                    }
                }, index * 200);
            });
        }

        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
        window.onload = function() {
            log('è·¯æ®µåˆ†æä¿®å¤éªŒè¯é¡µé¢åŠ è½½å®Œæˆ');
            log('========================================');
            log('ä¿®å¤è¦ç‚¹:');
            log('1. ç»Ÿä¸€ä½¿ç”¨mapAPIManagerç®¡ç†åœ°å›¾APIåŠ è½½');
            log('2. ä¿®å¤æ‰€æœ‰AMapå¼•ç”¨ä¸ºwindow.AMap');
            log('3. æ·»åŠ å®Œå–„çš„é”™è¯¯å¤„ç†å’Œæ¨¡æ‹Ÿæ•°æ®');
            log('4. ä¼˜åŒ–ç»„ä»¶ç”Ÿå‘½å‘¨æœŸç®¡ç†');
            log('5. æ·»åŠ ç¼ºå¤±çš„APIå‡½æ•°');
            log('========================================');
            
            // è‡ªåŠ¨æ£€æŸ¥APIçŠ¶æ€
            setTimeout(checkMapAPI, 1000);
        };
    </script>
</body>
</html> 